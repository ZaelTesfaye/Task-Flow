name: Deploy to EC2 with Docker Compose

on:
  push:
    branches:
      - main
  workflow_dispatch: # manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Build Docker Image 
      - name: Build
        run: |
          IMAGE_ID=${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}
          VERSION_TAG=$(echo $GITHUB_SHA | cut -c1-7)
          docker build -t $IMAGE_ID:latest -t $IMAGE_ID:$VERSION_TAG .

      # 3. Log in to Docker Hub (No change)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. Push Docker Image (No change)
      - name: Push Image
        run: |
          IMAGE_ID=${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}
          VERSION_TAG=$(echo $GITHUB_SHA | cut -c1-7)
          docker push $IMAGE_ID:latest
          docker push $IMAGE_ID:$VERSION_TAG

      # 5. Copy config files to EC2
      - name: Copy config files to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml, nginx.conf"
          target: "~/todo"

       # 5. Copy config files to EC2
      - name: Copy config files to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "nginx.conf"
          target: "~/todo"

      # 6. Inject SSL Certificates
      - name: Securely Inject SSL Certificates
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          request_pty: true
          script: |
            # Create the secure directory
            sudo mkdir -p /etc/nginx/ssl
            
            # Inject NGINX certificates (as before)
            echo "${{ secrets.NGINX_KEY }}" | sudo tee /etc/nginx/ssl/nginx-selfsigned.key > /dev/null
            echo "${{ secrets.NGINX_CERTIFICATE }}" | sudo tee /etc/nginx/ssl/nginx-selfsigned.crt > /dev/null
            
            # Set secure permissions
            sudo chmod 600 /etc/nginx/ssl/nginx-selfsigned.key
            sudo chmod 644 /etc/nginx/ssl/nginx-selfsigned.crt

      # 7. Inject Application .env File
      - name: Inject Production .env File
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/todo
            echo ${{ secrets.PROD_VARIABLES }}
            echo ${{ secrets.PROD_VARIABLES }} > .env
            echo "${{ secrets.PROD_VARIABLES }}" | tee .env > /dev/null
            chmod 600 .env

      # 8. Deploy via SSH to EC2
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/todo

            # Pull latest image
            docker pull ${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}:latest

            # set required variables for docker compose 
            export DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
            export IMAGE_NAME="${{ secrets.IMAGE_NAME }}" 

            # Recreate containers with update image (Docker compose doesn't detect image changes unless the yml file changes)
            docker compose up -d --force-recreate

            # Clean up old, unused images
            docker image prune -f

      # 9. Setup and Start Nginx
      - name: Setup & Start Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          request_pty: true
          script: |
            # Check if Nginx is installed, if not, install it.
            if ! command -v nginx >/dev/null 2>&1; then
                echo "Nginx not found. Installing..."
                sudo apt update -y
                sudo apt install -y nginx
            else
                echo "Nginx is already installed."
            fi

            # Copy custom nginx.conf to /etc/nginx and back up existing one
            sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup || true
            
            # Echo nginx.conf contents to EC2 server.
              sudo cp ~/todo/nginx.conf /etc/nginx/nginx.conf

            # Ensure Nginx starts on boot and is running
            sudo systemctl enable nginx
            sudo systemctl restart nginx