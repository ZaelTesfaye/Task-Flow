generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String?
  role      String   @default("user")
  createdAt DateTime @default(now())

  projects            Project[]
  projectMembers      ProjectMembers[]
  assignedTo          Task[]              @relation("assignedTo")
  assignedBy          Task[]              @relation("assignedBy")
  sentInvitations     ProjectInvitation[] @relation("InvitationInviter")
  receivedInvitations ProjectInvitation[] @relation("InvitationInvitee")
  PendingUpdates      PendingUpdates[]
  emailVerified       Boolean             @default(false)
  image               String?
  updatedAt           DateTime            @updatedAt
  sessions            Session[]
  accounts            Account[]

  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  notifications Notification[]

  @@map("user")
}

model Project {
  id          String @id @default(uuid())
  title       String
  description String

  ownerId   String
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  phases      Phase[]
  members     ProjectMembers[]
  invitations ProjectInvitation[]

  @@unique([ownerId, title])
}

model ProjectMembers {
  id       String   @id @default(uuid())
  joinedAt DateTime @default(now())
  access   String   @default("member") // owner, admin, member

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
}

model ProjectInvitation {
  id          String    @id @default(uuid())
  email       String
  status      String    @default("pending") // pending, accepted, declined, expired
  access      String    @default("member")
  createdAt   DateTime  @default(now())
  respondedAt DateTime?

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  inviterId String
  inviter   User   @relation("InvitationInviter", fields: [inviterId], references: [id], onDelete: Cascade)

  inviteeId String?
  invitee   User?   @relation("InvitationInvitee", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([projectId, email, status])
  @@index([projectId, status])
  @@index([inviteeId, status])
}

model Phase {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  tasks Task[]

  @@unique([name, projectId])
}

model Task {
  id          String   @id @default(uuid())
  title       String
  description String
  status      String   @default("active") //complete, active, pending(pending approval)
  createdAt   DateTime @default(now())

  assignedTo   String
  assignedUser User   @relation("assignedTo", fields: [assignedTo], references: [id], onDelete: Cascade)

  assignedBy     String
  assignedByUser User   @relation("assignedBy", fields: [assignedBy], references: [id], onDelete: Cascade)

  phaseId String
  Phase   Phase? @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  pendingUpdates PendingUpdates[]

  @@index([assignedTo])
  @@index([assignedBy])
  @@index([phaseId])
}

model PendingUpdates {
  id                String   @id @default(uuid())
  createdAt         DateTime @default(now())
  updateDescription String
  newStatus         String //complete, active, pending(pending approval)
  createdAtDate     DateTime @default(now())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  updateBy String
  user     User   @relation(fields: [updateBy], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([updateBy])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Notification {
  id        String   @id @default(uuid())
  type      String   @default("task_assigned") // task_assigned, task_updated, task_completed
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  taskId    String?
  projectId String?

  @@index([userId, isRead])
  @@index([userId, projectId, isRead])
  @@map("notification")
}
